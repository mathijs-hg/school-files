<br />
<pre>int format(libmtd_t libmtd,mtd_dev_info *mtd,ubigen_info *ui,ubi_scan_info *si,int start_eb,</pre>
<pre>          int novtbl)</pre>
<br />
<pre>{</pre>
<pre>  FILE *pFVar1;</pre>
<pre>  int iVar2;</pre>
<pre>  ubi_ec_hdr *hdr;</pre>
<pre>  int iVar3;</pre>
<pre>  int *piVar4;</pre>
<pre>  ubi_vtbl_record *__ptr;</pre>
<pre>  char *pcVar5;</pre>
<pre>  uint uVar6;</pre>
<pre>  ubi_vtbl_record *vtbl;</pre>
<pre>  int iVar7;</pre>
<pre>  size_t __size;</pre>
<pre>  DItype DVar8;</pre>
<pre>  int in_stack_ffffff88;</pre>
<pre>  ubi_ec_hdr *in_stack_ffffff8c;</pre>
<pre>  size_t in_stack_ffffff90;</pre>
<pre>  undefined4 in_stack_ffffff94;</pre>
<pre>  undefined4 local_58;</pre>
<pre>  ubi_vtbl_record *local_50;</pre>
<pre>  ubi_vtbl_record *local_48;</pre>
<pre>  int local_40;</pre>
<pre>  undefined4 local_3c;</pre>
<pre>  int local_38;</pre>
<pre>  undefined4 local_34;</pre>
<pre>  </pre>
<pre>  iVar2 = mtd-&gt;subpage_size;</pre>
<pre>  if (iVar2 == 0) {</pre>
<pre>    trap(0x1c00);</pre>
<pre>  }</pre>
<pre><span class="green">  __size = iVar2 * ((iVar2 + 0x3f) / iVar2)</span></span></pre>
<pre>  vtbl = (ubi_vtbl_record *)si;</pre>
<pre><span class="green"><span class="green">  hdr = (ubi_ec_hdr *)malloc(__size)</span></span></span></pre>
<pre>  if (hdr == (ubi_ec_hdr *)0x0) {</pre>
<pre>    piVar4 = __errno_location();</pre>
<pre>    iVar2 = *piVar4;</pre>
<pre>    fprintf(stderr,"%s: error!: cannot allocate %d bytes of memory\n","ubiformat",__size);</pre>
<pre>    pFVar1 = stderr;</pre>
<pre>    pcVar5 = strerror(iVar2);</pre>
<pre>    fprintf(pFVar1,"%*serror %d (%s)\n",0xb,&amp;DAT_0040e38c,iVar2,pcVar5);</pre>
<pre>    return -1;</pre>
<pre>  }</pre>
<pre>  memset(hdr,0xff,__size);</pre>
<pre>  if (start_eb &lt; mtd-&gt;eb_cnt) {</pre>
<pre>    iVar2 = start_eb &lt;&lt; 2;</pre>
<pre>    local_34 = 0xffffffff;</pre>
<pre>    local_3c = 0xffffffff;</pre>
<pre>    local_38 = -1;</pre>
<pre>    local_40 = -1;</pre>
<pre>    local_48 = (ubi_vtbl_record *)0xffffffff;</pre>
<pre>    local_50 = (ubi_vtbl_record *)0xffffffff;</pre>
<pre>    uVar6 = args._0_4_;</pre>
<pre>    do {</pre>
<pre>      while( true ) {</pre>
<pre>        if ((uVar6 &amp; 6) == 0) {</pre>
<pre>          DVar8 = __divdi3(CONCAT44(in_stack_ffffff8c,in_stack_ffffff88),</pre>
<pre>                           CONCAT44(in_stack_ffffff94,in_stack_ffffff90));</pre>
<pre>          vtbl = (ubi_vtbl_record *)((ulonglong)DVar8 &gt;&gt; 0x20);</pre>
<pre>          printf("\rubiformat: formatting eraseblock %d -- %2lld %% complete  ",start_eb,(int)DVar8)</pre>
<pre>          ;</pre>
<pre>          fflush(stdout);</pre>
<pre>          uVar6 = args._0_4_;</pre>
<pre>        }</pre>
<pre>        iVar7 = *(int *)((int)si-&gt;ec + iVar2);</pre>
<pre>        if (iVar7 != -4) break;</pre>
<pre>LAB_00403cd8:</pre>
<pre>        start_eb = (int)(uint32_t **)start_eb + 1;</pre>
<pre>        iVar2 = iVar2 + 4;</pre>
<pre>        if (mtd-&gt;eb_cnt &lt;= start_eb) goto LAB_00403ed8;</pre>
<pre>      }</pre>
<pre>      if ((uVar6 &amp; 8) == 0) {</pre>
<pre>        if (iVar7 &lt; 0) {</pre>
<pre>          local_58 = *(undefined4 *)((int)&amp;si-&gt</span>ean_ec + 4);</pre>
<pre>          iVar7 = *(int *)&amp;si-&gt</span>ean_ec;</pre>
<pre>        }</pre>
<pre>        else {</pre>
<pre>          local_58 = 0;</pre>
<pre>          iVar7 = iVar7 + 1;</pre>
<pre>        }</pre>
<pre>      }</pre>
<pre>      else {</pre>
<pre>        local_58 = args.ec._4_4_;</pre>
<pre>        iVar7 = (int)args.ec;</pre>
<pre>      }</pre>
<pre>      ubigen_init_ec_hdr(ui,hdr,CONCAT44(in_stack_ffffff8c,in_stack_ffffff88));</pre>
<pre>      if ((args._0_4_ &amp; 4) != 0) {</pre>
<pre>        printf("%s: eraseblock %d: erase","ubiformat",start_eb);</pre>
<pre>        fflush(stdout);</pre>
<pre>      }</pre>
<pre>      vtbl = (ubi_vtbl_record *)start_eb;</pre>
<pre>      iVar3 = mtd_erase(libmtd,mtd,args.node_fd,start_eb);</pre>
<pre>      if (iVar3 != 0) {</pre>
<pre>        if ((args._0_4_ &amp; 2) == 0) {</pre>
<pre>          putchar(10);</pre>
<pre>        }</pre>
<pre>        piVar4 = __errno_location();</pre>
<pre>        in_stack_ffffff88 = *piVar4;</pre>
<pre>        fprintf(stderr,"%s: error!: failed to erase eraseblock %d\n","ubiformat",start_eb);</pre>
<pre>        pFVar1 = stderr;</pre>
<pre>        in_stack_ffffff8c = (ubi_ec_hdr *)strerror(in_stack_ffffff88);</pre>
<pre>        vtbl = (ubi_vtbl_record *)&amp;DAT_0040e38c;</pre>
<pre>        fprintf(pFVar1,"%*serror %d (%s)\n",0xb);</pre>
<pre>        if (*piVar4 == 5) {</pre>
<pre>          iVar7 = mark_bad(mtd,si,start_eb);</pre>
<pre>          uVar6 = args._0_4_;</pre>
<pre>joined_r0x00403ccc:</pre>
<pre>          args._0_4_ = uVar6;</pre>
<pre>          if (iVar7 == 0) goto LAB_00403cd8;</pre>
<pre>        }</pre>
<pre>        goto out_free;</pre>
<pre>      }</pre>
<pre>      if (((local_50 == (ubi_vtbl_record *)0xffffffff) ||</pre>
<pre>          (local_48 == (ubi_vtbl_record *)0xffffffff)) &amp;&amp; (novtbl == 0)) {</pre>
<pre>        if (local_50 == (ubi_vtbl_record *)0xffffffff) {</pre>
<pre>          local_3c = local_58;</pre>
<pre>          local_50 = (ubi_vtbl_record *)start_eb;</pre>
<pre>          local_40 = iVar7;</pre>
<pre>        }</pre>
<pre>        else if (local_48 == (ubi_vtbl_record *)0xffffffff) {</pre>
<pre>          local_34 = local_58;</pre>
<pre>          local_48 = (ubi_vtbl_record *)start_eb;</pre>
<pre>          local_38 = iVar7;</pre>
<pre>        }</pre>
<pre>        uVar6 = args._0_4_;</pre>
<pre>        if ((args._0_4_ &amp; 4) != 0) {</pre>
<pre>          puts(", do not write EC, leave for vtbl");</pre>
<pre>          uVar6 = args._0_4_;</pre>
<pre>        }</pre>
<pre>        goto LAB_00403cd8;</pre>
<pre>      }</pre>
<pre>      if ((args._0_4_ &amp; 4) != 0) {</pre>
<pre>        printf(", write EC %lld\n");</pre>
<pre>        fflush(stdout);</pre>
<pre>      }</pre>
<pre>      in_stack_ffffff88 = 0;</pre>
<pre>      in_stack_ffffff94 = 0;</pre>
<pre>      vtbl = (ubi_vtbl_record *)start_eb;</pre>
<pre>      in_stack_ffffff8c = hdr;</pre>
<pre>      in_stack_ffffff90 = __size;</pre>
<pre><span class="green">      iVar7 = mtd_write(libmtd,mtd,args.node_fd,start_eb,0,hdr,__size,(void *)0x0,0,'\0')</span></span></pre>
<pre>      if (iVar7 != 0) {</pre>
<pre>        if ((args._0_4_ &amp; 6) == 0) {</pre>
<pre>          putchar(10);</pre>
<pre>        }</pre>
<pre>        piVar4 = __errno_location();</pre>
<pre>        in_stack_ffffff88 = *piVar4;</pre>
<pre>        fprintf(stderr,"%s: error!: cannot write EC header (%d bytes buffer) to eraseblock %d\n",</pre>
<pre>                "ubiformat",__size,start_eb);</pre>
<pre>        pFVar1 = stderr;</pre>
<pre>        in_stack_ffffff8c = (ubi_ec_hdr *)strerror(in_stack_ffffff88);</pre>
<pre>        fprintf(pFVar1,"%*serror %d (%s)\n",0xb,&amp;DAT_0040e38c);</pre>
<pre>        if (*piVar4 != 5) {</pre>
<pre>          if (args.subpage_size != mtd-&gt</span>in_io_size) {</pre>
<pre>            printf("%s: may be sub-page size is incorrect?\n","ubiformat");</pre>
<pre>          }</pre>
<pre>          goto out_free;</pre>
<pre>        }</pre>
<pre>        vtbl = (ubi_vtbl_record *)start_eb;</pre>
<pre>        iVar7 = mtd_torture(libmtd,mtd,args.node_fd,start_eb);</pre>
<pre>        if (iVar7 != 0) {</pre>
<pre>          iVar7 = mark_bad(mtd,si,start_eb);</pre>
<pre>          uVar6 = args._0_4_;</pre>
<pre>          goto joined_r0x00403ccc;</pre>
<pre>        }</pre>
<pre>      }</pre>
<pre>      start_eb = (int)(uint32_t **)start_eb + 1;</pre>
<pre>      iVar2 = iVar2 + 4;</pre>
<pre>      uVar6 = args._0_4_;</pre>
<pre>    } while (start_eb &lt; mtd-&gt;eb_cnt);</pre>
<pre>  }</pre>
<pre>  else {</pre>
<pre>    local_38 = -1;</pre>
<pre>    local_3c = 0xffffffff;</pre>
<pre>    local_34 = 0xffffffff;</pre>
<pre>    local_40 = -1;</pre>
<pre>    local_48 = (ubi_vtbl_record *)0xffffffff;</pre>
<pre>    local_50 = (ubi_vtbl_record *)0xffffffff;</pre>
<pre>  }</pre>
<pre>LAB_00403ed8:</pre>
<pre>  if ((args._0_4_ &amp; 6) == 0) {</pre>
<pre>    putchar(10);</pre>
<pre>  }</pre>
<pre>  if (novtbl == 0) {</pre>
<pre>    if ((local_50 == (ubi_vtbl_record *)0xffffffff) || (local_48 == (ubi_vtbl_record *)0xffffffff))</pre>
<pre>    {</pre>
<pre>      fprintf(stderr,"%s: error!: no eraseblocks for volume table\n","ubiformat");</pre>
<pre>    }</pre>
<pre>    else {</pre>
<pre>      if ((args._0_4_ &amp; 4) != 0) {</pre>
<pre>        vtbl = local_48;</pre>
<pre>        printf("%s: write volume table to eraseblocks %d and %d\n","ubiformat",local_50);</pre>
<pre>      }</pre>
<pre>      __ptr = ubigen_create_empty_vtbl(ui);</pre>
<pre>      if (__ptr != (ubi_vtbl_record *)0x0) {</pre>
<pre>        iVar2 = ubigen_write_layout_vol</pre>
<pre>                          (ui,(int)local_50,(int)local_48,CONCAT44(local_3c,local_40),</pre>
<pre>                           CONCAT44(local_34,local_38),vtbl,(int)__ptr);</pre>
<pre>        free(__ptr);</pre>
<pre>        if (iVar2 == 0) goto LAB_00403fb8;</pre>
<pre>        fprintf(stderr,"%s: error!: cannot write layout volume\n","ubiformat");</pre>
<pre>      }</pre>
<pre>    }</pre>
<pre>out_free:</pre>
<pre>    free(hdr);</pre>
<pre>    iVar2 = -1;</pre>
<pre>  }</pre>
<pre>  else {</pre>
<pre>LAB_00403fb8:</pre>
<pre>    free(hdr);</pre>
<pre>    iVar2 = 0;</pre>
<pre>  }</pre>
<pre>  return iVar2;</pre>
<pre>}</pre>
<br />
<pre>[ASK_GPT] efe148ade77a4a1f</pre>
