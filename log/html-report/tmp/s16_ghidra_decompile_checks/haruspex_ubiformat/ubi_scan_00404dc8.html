<br />
<pre>int ubi_scan(mtd_dev_info *mtd,int fd,ubi_scan_info **info,int verbose)</pre>
<br />
<pre>{</pre>
<pre>  bool bVar1;</pre>
<pre>  __be32 *p_Var2;</pre>
<pre>  FILE *pFVar3;</pre>
<pre>  ubi_scan_info *__ptr;</pre>
<pre>  uint32_t *puVar4;</pre>
<pre>  int iVar5;</pre>
<pre>  ubi_ec_hdr *puVar6;</pre>
<pre>  uint32_t uVar7;</pre>
<pre>  int *piVar8;</pre>
<pre>  uint uVar9;</pre>
<pre>  char *pcVar10;</pre>
<pre>  uint uVar11;</pre>
<pre>  size_t __nmemb;</pre>
<pre>  ubi_ec_hdr *eb;</pre>
<pre>  int iVar12;</pre>
<pre>  int iVar13;</pre>
<pre>  UDItype UVar14;</pre>
<pre>  DItype DVar15;</pre>
<pre>  ubi_ec_hdr *in_stack_ffffff68;</pre>
<pre>  ubi_ec_hdr *in_stack_ffffff6c;</pre>
<pre>  undefined4 in_stack_ffffff70;</pre>
<pre>  undefined4 in_stack_ffffff74;</pre>
<pre>  ubi_ec_hdr ech;</pre>
<pre>  uint local_38;</pre>
<pre>  uint local_34;</pre>
<pre>  uint local_30;</pre>
<pre>  </pre>
<pre><span class="green"><span class="green">  __ptr = (ubi_scan_info *)calloc(1,0x30)</span></span></span></pre>
<pre>  if (__ptr == (ubi_scan_info *)0x0) {</pre>
<pre>    iVar12 = -1;</pre>
<pre>    piVar8 = __errno_location();</pre>
<pre>    iVar13 = *piVar8;</pre>
<pre>    fprintf(stderr,"%s: error!: cannot allocate %zd bytes of memory\n","libscan",0x30);</pre>
<pre>    pFVar3 = stderr;</pre>
<pre>    pcVar10 = strerror(iVar13);</pre>
<pre>    fprintf(pFVar3,"%*serror %d (%s)\n",9,&amp;DAT_0040e38c,iVar13,pcVar10);</pre>
<pre>  }</pre>
<pre>  else {</pre>
<pre>    __nmemb = mtd-&gt;eb_cnt;</pre>
<pre><span class="green"><span class="green">    puVar4 = (uint32_t *)calloc(__nmemb,4)</span></span></span></pre>
<pre>    __ptr-&gt;ec = puVar4;</pre>
<pre>    if (puVar4 == (uint32_t *)0x0) {</pre>
<pre>      piVar8 = __errno_location();</pre>
<pre>      iVar12 = *piVar8;</pre>
<pre>      fprintf(stderr,"%s: error!: cannot allocate %zd bytes of memory\n","libscan",0x30);</pre>
<pre>      pFVar3 = stderr;</pre>
<pre>      pcVar10 = strerror(iVar12);</pre>
<pre>      fprintf(pFVar3,"%*serror %d (%s)\n",9,&amp;DAT_0040e38c,iVar12,pcVar10);</pre>
<pre>out_si:</pre>
<pre>      iVar12 = -1;</pre>
<pre>      free(__ptr);</pre>
<pre>      *info = (ubi_scan_info *)0x0;</pre>
<pre>    }</pre>
<pre>    else {</pre>
<pre>      bVar1 = verbose == 2;</pre>
<pre>      __ptr-&gt;data_offs = -1;</pre>
<pre>      __ptr-&gt;vid_hdr_offs = -1;</pre>
<pre>      if (bVar1) {</pre>
<pre>        printf("%s: start scanning eraseblocks 0-%d\n","libscan",__nmemb);</pre>
<pre>      }</pre>
<pre>      iVar12 = mtd-&gt;eb_cnt;</pre>
<pre>      local_38 = (uint)(verbose == 1);</pre>
<pre>      if (0 &lt; iVar12) {</pre>
<pre>        iVar13 = 0;</pre>
<pre>        eb = (ubi_ec_hdr *)0x0;</pre>
<pre>        do {</pre>
<pre>          puVar6 = in_stack_ffffff68;</pre>
<pre>          if (bVar1) {</pre>
<pre>            printf("%s: scanning eraseblock %d","libscan",eb);</pre>
<pre>            fflush(stdout);</pre>
<pre>            puVar6 = in_stack_ffffff68;</pre>
<pre>          }</pre>
<pre>          if (local_38 != 0) {</pre>
<pre>            DVar15 = __divdi3(CONCAT44(in_stack_ffffff6c,puVar6),</pre>
<pre>                              CONCAT44(in_stack_ffffff74,in_stack_ffffff70));</pre>
<pre>            printf("\rlibscan: scanning eraseblock %d -- %2lld %% complete  ",eb,(int)DVar15,</pre>
<pre>                   (int)((ulonglong)DVar15 &gt;&gt; 0x20));</pre>
<pre>            fflush(stdout);</pre>
<pre>          }</pre>
<pre>          iVar12 = mtd_is_bad(mtd,fd,(int)eb);</pre>
<pre>          if (iVar12 == -1) {</pre>
<pre>out_ec:</pre>
<pre>            free(__ptr-&gt;ec);</pre>
<pre>            goto out_si;</pre>
<pre>          }</pre>
<pre>          in_stack_ffffff68 = &amp;ech;</pre>
<pre>          if (iVar12 == 0) {</pre>
<pre>            in_stack_ffffff6c = (ubi_ec_hdr *)0x40;</pre>
<pre><span class="green">            iVar12 = mtd_read(mtd,fd,(int)eb,0,in_stack_ffffff68,0x40)</span></span></pre>
<pre>            if (iVar12 &lt; 0) goto out_ec;</pre>
<pre>            puVar6 = &amp;ech;</pre>
<pre>            if ((ech.magic &gt;&gt; 0x18 | ech.magic &lt;&lt; 0x18 | (ech.magic &amp; 0xff00) &lt;&lt; 8 |</pre>
<pre>                (ech.magic &amp; 0xff0000) &gt;&gt; 8) == 0x55424923) {</pre>
<pre>              local_34 = 0xff0000;</pre>
<pre>              uVar7 = mtd_crc32(0xffffffff,&amp;ech,0x3c);</pre>
<pre>              if ((ech.hdr_crc &gt;&gt; 0x18 | ech.hdr_crc &lt;&lt; 0x18 | (ech.hdr_crc &amp; 0xff00) &lt;&lt; 8 |</pre>
<pre>                  (ech.hdr_crc &amp; local_34) &gt;&gt; 8) == uVar7) {</pre>
<pre>                uVar11 = (uint)ech.ec &gt;&gt; 0x18 |</pre>
<pre>                         (uint)ech.ec &lt;&lt; 0x18 | ((uint)ech.ec &amp; 0xff00) &lt;&lt; 8 |</pre>
<pre>                         ((uint)ech.ec &amp; local_34) &gt;&gt; 8;</pre>
<pre>                uVar9 = ech.ec._4_4_ &gt;&gt; 0x18 | ech.ec._4_4_ &lt;&lt; 0x18 | (ech.ec._4_4_ &amp; 0xff00) &lt;&lt; 8 |</pre>
<pre>                        (ech.ec._4_4_ &amp; local_34) &gt;&gt; 8;</pre>
<pre>                if ((uVar11 != 0) || (0x7fffffff &lt; uVar9)) {</pre>
<pre>                  if (local_38 != 0) {</pre>
<pre>                    local_34 = uVar9;</pre>
<pre>                    local_30 = uVar11;</pre>
<pre>                    putchar(10);</pre>
<pre>                    uVar9 = local_34;</pre>
<pre>                    uVar11 = local_30;</pre>
<pre>                  }</pre>
<pre>                  fprintf(stderr,</pre>
<pre>                          "%s: error!: erase counter in EB %d is %llu, while this program expects them to be less than %u\n"</pre>
<pre>                          ,"libscan",eb,uVar9,uVar11,0x7fffffff);</pre>
<pre>                  goto out_ec;</pre>
<pre>                }</pre>
<pre>                if (__ptr-&gt;vid_hdr_offs == 0xffffffff) {</pre>
<pre>                  iVar12 = mtd-&gt</span>in_io_size;</pre>
<pre>                  uVar11 = ech.data_offset &gt;&gt; 0x18 | ech.data_offset &lt;&lt; 0x18 |</pre>
<pre>                           (ech.data_offset &amp; 0xff00) &lt;&lt; 8 | (ech.data_offset &amp; local_34) &gt;&gt; 8;</pre>
<pre>                  if (iVar12 == 0) {</pre>
<pre>                    trap(0x1c00);</pre>
<pre>                  }</pre>
<pre>                  __ptr-&gt;vid_hdr_offs =</pre>
<pre>                       ech.vid_hdr_offset &gt;&gt; 0x18 | ech.vid_hdr_offset &lt;&lt; 0x18 |</pre>
<pre>                       (ech.vid_hdr_offset &amp; 0xff00) &lt;&lt; 8 | (ech.vid_hdr_offset &amp; local_34) &gt;&gt; 8;</pre>
<pre>                  __ptr-&gt;data_offs = uVar11;</pre>
<pre>                  if ((int)uVar11 % iVar12 == 0) {</pre>
<pre>LAB_004054f0:</pre>
<pre>                    __ptr-&gt;ok_cnt = __ptr-&gt;ok_cnt + 1;</pre>
<pre>                    *(uint *)((int)__ptr-&gt;ec + iVar13) = uVar9;</pre>
<pre>                    if (bVar1) {</pre>
<pre>                      printf(": OK, erase counter %u\n");</pre>
<pre>                    }</pre>
<pre>                    goto LAB_00404eec;</pre>
<pre>                  }</pre>
<pre>                  if (local_38 != 0) {</pre>
<pre>                    putchar(10);</pre>
<pre>                  }</pre>
<pre>                  if (bVar1) {</pre>
<pre>                    puts(": corrupted because of the below");</pre>
<pre>                  }</pre>
<pre>                  in_stack_ffffff6c = (ubi_ec_hdr *)mtd-&gt</span>in_io_size;</pre>
<pre>                  iVar12 = __ptr-&gt;data_offs;</pre>
<pre>                  pcVar10 = </pre>
<pre>                  "%s: warning!: bad data offset %d at eraseblock %d (nof multiple of min. I/O unit size %d)\n"</pre>
<pre>                  ;</pre>
<pre>                  in_stack_ffffff68 = eb;</pre>
<pre>                }</pre>
<pre>                else if (__ptr-&gt;vid_hdr_offs ==</pre>
<pre>                         (ech.vid_hdr_offset &gt;&gt; 0x18 | ech.vid_hdr_offset &lt;&lt; 0x18 |</pre>
<pre>                          (ech.vid_hdr_offset &amp; 0xff00) &lt;&lt; 8 | (ech.vid_hdr_offset &amp; local_34) &gt;&gt; 8)</pre>
<pre>                        ) {</pre>
<pre>                  if ((ech.data_offset &gt;&gt; 0x18 | ech.data_offset &lt;&lt; 0x18 |</pre>
<pre>                       (ech.data_offset &amp; 0xff00) &lt;&lt; 8 | (ech.data_offset &amp; local_34) &gt;&gt; 8) ==</pre>
<pre>                      __ptr-&gt;data_offs) goto LAB_004054f0;</pre>
<pre>                  if (local_38 != 0) {</pre>
<pre>                    putchar(10);</pre>
<pre>                  }</pre>
<pre>                  if (bVar1) {</pre>
<pre>                    puts(": corrupted because of the below");</pre>
<pre>                  }</pre>
<pre>                  iVar12 = __ptr-&gt;data_offs;</pre>
<pre>                  pcVar10 = </pre>
<pre>                  "%s: warning!: inconsistent data offset: was %d, but is %d in eraseblock %d\n";</pre>
<pre>                  in_stack_ffffff68 =</pre>
<pre>                       (ubi_ec_hdr *)</pre>
<pre>                       (ech.data_offset &gt;&gt; 0x18 | ech.data_offset &lt;&lt; 0x18 |</pre>
<pre>                        (ech.data_offset &amp; 0xff00) &lt;&lt; 8 | ech.data_offset &gt;&gt; 8 &amp; 0xff00);</pre>
<pre>                  in_stack_ffffff6c = eb;</pre>
<pre>                }</pre>
<pre>                else {</pre>
<pre>                  if (local_38 != 0) {</pre>
<pre>                    putchar(10);</pre>
<pre>                  }</pre>
<pre>                  if (bVar1) {</pre>
<pre>                    puts(": corrupted because of the below");</pre>
<pre>                  }</pre>
<pre>                  iVar12 = __ptr-&gt;vid_hdr_offs;</pre>
<pre>                  pcVar10 = </pre>
<pre>                  "%s: warning!: inconsistent VID header offset: was %d, but is %d in eraseblock %d\n"</pre>
<pre>                  ;</pre>
<pre>                  in_stack_ffffff68 =</pre>
<pre>                       (ubi_ec_hdr *)</pre>
<pre>                       (ech.vid_hdr_offset &gt;&gt; 0x18 | ech.vid_hdr_offset &lt;&lt; 0x18 |</pre>
<pre>                        (ech.vid_hdr_offset &amp; 0xff00) &lt;&lt; 8 | ech.vid_hdr_offset &gt;&gt; 8 &amp; 0xff00);</pre>
<pre>                  in_stack_ffffff6c = eb;</pre>
<pre>                }</pre>
<pre>                fprintf(stderr,pcVar10,"libscan",iVar12);</pre>
<pre>                fprintf(stderr,"%s: warning!: treat eraseblock %d as corrupted\n","libscan",eb);</pre>
<pre>                __ptr-&gt;corrupted_cnt = __ptr-&gt;corrupted_cnt + 1;</pre>
<pre>                *(undefined4 *)((int)__ptr-&gt;ec + iVar13) = 0xfffffffe;</pre>
<pre>              }</pre>
<pre>              else {</pre>
<pre>                __ptr-&gt;corrupted_cnt = __ptr-&gt;corrupted_cnt + 1;</pre>
<pre>                *(undefined4 *)((int)__ptr-&gt;ec + iVar13) = 0xfffffffe;</pre>
<pre>                if (bVar1) {</pre>
<pre>                  printf(": bad CRC %#08x, should be %#08x\n",uVar7,</pre>
<pre>                         ech.hdr_crc &gt;&gt; 0x18 | ech.hdr_crc &lt;&lt; 0x18 | (ech.hdr_crc &amp; 0xff00) &lt;&lt; 8 |</pre>
<pre>                         (ech.hdr_crc &amp; local_34) &gt;&gt; 8);</pre>
<pre>                }</pre>
<pre>              }</pre>
<pre>            }</pre>
<pre>            else {</pre>
<pre>              do {</pre>
<pre>                p_Var2 = &amp;puVar6-&gt</span>agic;</pre>
<pre>                puVar6 = (ubi_ec_hdr *)((int)&amp;puVar6-&gt</span>agic + 1);</pre>
<pre>                if (*(char *)p_Var2 != -1) {</pre>
<pre>                  __ptr-&gt;alien_cnt = __ptr-&gt;alien_cnt + 1;</pre>
<pre>                  *(undefined4 *)((int)__ptr-&gt;ec + iVar13) = 0xfffffffd;</pre>
<pre>                  if (bVar1) {</pre>
<pre>                    puts(": alien");</pre>
<pre>                  }</pre>
<pre>                  goto LAB_00404eec;</pre>
<pre>                }</pre>
<pre>              } while (puVar6 != (ubi_ec_hdr *)&amp;local_38);</pre>
<pre>              __ptr-&gt;empty_cnt = __ptr-&gt;empty_cnt + 1;</pre>
<pre>              *(undefined4 *)((int)__ptr-&gt;ec + iVar13) = 0xffffffff;</pre>
<pre>              if (bVar1) {</pre>
<pre>                puts(": empty");</pre>
<pre>              }</pre>
<pre>            }</pre>
<pre>          }</pre>
<pre>          else {</pre>
<pre>            __ptr-&gt;bad_cnt = __ptr-&gt;bad_cnt + 1;</pre>
<pre>            *(undefined4 *)((int)__ptr-&gt;ec + iVar13) = 0xfffffffc;</pre>
<pre>            in_stack_ffffff68 = puVar6;</pre>
<pre>            if (bVar1) {</pre>
<pre>              puts(": bad");</pre>
<pre>              in_stack_ffffff68 = puVar6;</pre>
<pre>            }</pre>
<pre>          }</pre>
<pre>LAB_00404eec:</pre>
<pre>          iVar12 = mtd-&gt;eb_cnt;</pre>
<pre>          eb = (ubi_ec_hdr *)((int)&amp;eb-&gt</span>agic + 1);</pre>
<pre>          iVar13 = iVar13 + 4;</pre>
<pre>        } while ((int)eb &lt; iVar12);</pre>
<pre>      }</pre>
<pre>      iVar13 = __ptr-&gt;ok_cnt;</pre>
<pre>      if (iVar13 != 0) {</pre>
<pre>        if (0 &lt; iVar12) {</pre>
<pre>          iVar5 = 0;</pre>
<pre>          do {</pre>
<pre>            iVar5 = iVar5 + 1;</pre>
<pre>          } while (iVar5 != iVar12);</pre>
<pre>        }</pre>
<pre>        UVar14 = __udivdi3(CONCAT44(in_stack_ffffff6c,in_stack_ffffff68),</pre>
<pre>                           CONCAT44(in_stack_ffffff74,in_stack_ffffff70));</pre>
<pre>        __ptr-&gt</span>ean_ec = UVar14;</pre>
<pre>      }</pre>
<pre>      __ptr-&gt;good_cnt = iVar12 - __ptr-&gt;bad_cnt;</pre>
<pre>      if (bVar1) {</pre>
<pre>        printf("%s: finished, mean EC %lld, %d OK, %d corrupted, %d empty, %d alien, bad %d\n",</pre>
<pre>               "libscan",*(undefined4 *)&amp;__ptr-&gt</span>ean_ec,*(undefined4 *)((int)&amp;__ptr-&gt</span>ean_ec + 4),</pre>
<pre>               iVar13,__ptr-&gt;corrupted_cnt,__ptr-&gt;empty_cnt,__ptr-&gt;alien_cnt,__ptr-&gt;bad_cnt);</pre>
<pre>      }</pre>
<pre>      iVar12 = 0;</pre>
<pre>      *info = __ptr;</pre>
<pre>      if (local_38 != 0) {</pre>
<pre>        putchar(10);</pre>
<pre>      }</pre>
<pre>    }</pre>
<pre>  }</pre>
<pre>  return iVar12;</pre>
<pre>}</pre>
<br />
<pre>[ASK_GPT] cc64609d966bba8d</pre>
