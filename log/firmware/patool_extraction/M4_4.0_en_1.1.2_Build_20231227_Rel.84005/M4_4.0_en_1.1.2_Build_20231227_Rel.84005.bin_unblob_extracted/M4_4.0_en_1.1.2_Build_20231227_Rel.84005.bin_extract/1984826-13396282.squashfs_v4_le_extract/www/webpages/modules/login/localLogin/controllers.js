!function(u){u.su.moduleManager.define("localLogin",{services:["ajax"],models:["localLogin","localLoginControl"],stores:[],views:["localLoginView"],deps:["login","main"],listeners:{"ev_on_launch":function(e,n,o,t,l,i,a){u.encrypt.encryptManager.cleanStorage(),u.su.encryptor=u.encrypt.encryptManager.genEncryptor(),a.ajax.request({proxy:"keyProxy",success:function(e){var o=e;o&&o.password&&(n.encryptKey=o.password)}})}},init:function(o,e,n,t,l,i){this.control({"#local-login-pwd":{"keyup":function(e){13==e.keyCode&&o.doLogin()}},"#local-login-button":{"ev_button_click":function(){o.doLogin()}},".local-login-switch-to-tp":{"click":function(e){l.login.goToChildModule("tpLogin")}},".local-login-forget-pwd":{"click":function(){e.localLoginView.forgetPasswordMsg.show()}}})}},function(r,c,s,e,a,n){return{encryptKey:null,doLogin:function(){if(s.localLoginControl.password.validate()){var o=s.localLoginControl.password.getValue(),e=s.localLoginControl.password.doEncrypt(r.encryptKey);s.localLogin.password.setValue(e),c.localLoginView.loginBtn.disable(),n.ajax.request({proxy:"authProxy",success:function(e){u.su.encryptor.setRSAKey(e.key[0],e.key[1]),u.su.encryptor.setSeq(e.seq),u.su.encryptor.genAESKey(),u.su.encryptor.setHash("admin",o),u.encrypt.encryptManager.recordEncryptor(),s.localLogin.login({preventFailEvent:!0,success:r.loginSuccessDealer,fail:r.loginFailDealer,error:function(){c.localLoginView.loginBtn.enable()}})},fail:function(){c.localLoginView.loginBtn.enable()},error:function(){c.localLoginView.loginBtn.enable()}})}},loginSuccessDealer:function(e,o){var n,t,l,i=e.stok||(n="12345",t=top.location.href,0<=(l=t.indexOf("stok="))&&(n=t.substring(l+5)),n);localStorage&&(a.main.setToken(i),a.main.reload())},loginFailDealer:function(e,o){var n=e.result;switch(c.localLoginView.loginBtn.enable(),o){case-5002:r.disableButton(c.localLoginView.loginBtn);var t,l=n.failureCount,i=n.attemptsAllowed;if(l<7){var a=String(-5002).replace(/^-/,"E");s.localLoginControl.password.setError(u.su.CHAR.ERROR[a])}else t=u.su.CHAR.LOGIN.LOGIN_FAILED_COUNT.replace("%num1",l).replace("%num2",i),c.localLoginView.leftAttemptsMsgContent.setText(t),c.localLoginView.leftAttemptsMsg.show();break;case-5003:c.localLoginView.maxAttemptsMsgContent.setText(u.su.CHAR.ERROR["00000089"]),c.localLoginView.maxAttemptsMsg.show()}},queryRecoveryPasswordMethod:function(){var e=u.Deferred();return e.resolve(!0),e.promise()},disableButton:function(e){r.countDownSec=30,e.setText(u.su.CHAR.LOGIN.LOGIN_BUTTON_COUNTDOWN.replace("%num",r.countDownSec)),r.intervalId=setInterval(function o(){r.countDownSec--,0<r.countDownSec?e.setText(u.su.CHAR.LOGIN.LOGIN_BUTTON_COUNTDOWN.replace("%num",r.countDownSec)):(clearInterval(r.intervalId),e.enable(),e.setText(u.su.CHAR.LOGIN.LOGIN_BUTTON_TEXT))},1e3),e.disable()}}})}(jQuery);