!function(l){l.su.moduleManager.define("firmwareDeco",{views:["firmwareDecoView"],models:["firmwareTypeM"],stores:["onlineUpgradeStore","firmwareTypeS"],services:["ajax","vtype","language","device"],deps:["main"],listeners:{"ev_on_launch":function(e,r,a,i,o,t,c){var n=c.device.getCurrentMode();r.isMobileMode="LTE"===n.sysMode||"Mobile_5G"===n.sysMode,o.onlineUpgradeStore.load(),"RE"===(this.currentMode=n).workMode?a.firmwareDecoView.onlineUpgradeCtn.hide():a.firmwareDecoView.onlineUpgradeCtn.show()}},init:function(f,t,a,g,e,i){this.configViews({id:"firmwareDecoView",items:[{id:"firmware-list-grid",configs:{minLines:0,columns:[{text:l.su.CHAR.FIRMWARE.TYPE,dataIndex:"deviceModel",width:"12%",renderer:function(e){var r,a;switch(e){case"M1300":case"M5":case"M9Plus":case"P7":r="icon-device-m5";break;case"M4":case"E4":case"E4R":case"W2400":case"M3":case"E3":case"M4R":case"HC4":case"AC1200":r="icon-device-m4r";break;case"M3W":r="icon-device-m3w";break;case"X20":case"HX20":case"X50":case"X60":case"X73":case"W6000":case"W3600":r="icon-device-x20";break;case"X68":case"X75":case"XE75":case"XE5300":case"X76":case"X80":case"X3600":r="icon-device-x68";break;case"X90":case"X96":case"X95":case"XE200":case"XE95":case"X5700":case"X80-5G":case"X50-5G":r="icon-device-x90";break;case"X55":case"X25":r="icon-device-x25";break;case"X58-4G":r="icon-device-x58";break;default:r="icon-device-m5"}return a='<a href="javascript:void(0)" class="grid-content-btn" style=\'cursor: default\'>',a+="<span class='icon-device "+r+"'></span>",a+="</a>"}},{text:l.su.CHAR.FIRMWARE.DEVICE_NAME,dataIndex:"nickName",width:"20%",renderer:function(e,r){var a="";return"disconnected"===r.groupStatus&&(a="("+l.su.CHAR.REBOOT.OFFLINE+")"),"custom"!==e?l.su.escapeHtml(e)+a:l.su.escapeHtml(l.su.b64Decode(r.customNickname))+a}},{text:l.su.CHAR.FIRMWARE.MODEL,dataIndex:"deviceModel",width:"15%",renderer:function(e,r){var a=r.hardwareVer;return null!==a&&(e+="("+a+")"),e}},{text:l.su.CHAR.FIRMWARE.FIRMWARE_VERSION,dataIndex:"softwareVer",renderer:function(e){return e}},{text:l.su.CHAR.FIRMWARE.LATEST_FIRMWARE_VERSION,dataIndex:"newVersion",renderer:function(e,r){var a;switch(r.deviceModel){case"M4R":a="https://www.tp-link.com/en/support/download/deco-m4/";break;case"P7":a="https://www.tp-link.com/en/support/download/deco-p7/";break;case"M9Plus":a="https://www.tp-link.com/en/support/download/deco-m9-plus/";break;case"M5":a="https://www.tp-link.com/en/support/download/deco-m5/";break;case"M3W":a="https://www.tp-link.com/en/support/download/deco-m3w/";break;case"X90":a="https://www.tp-link.com/en/support/download/deco-x90/";break;case"X60":a="https://www.tp-link.com/en/support/download/deco-x60/";break;case"X20":a="https://www.tp-link.com/en/support/download/deco-x20/";break;case"P9":a="https://www.tp-link.com/en/support/download/deco-p9/";break;case"S4":a="https://www.tp-link.com/en/support/download/deco-s4/";break;case"E4R":a="https://www.tp-link.com/en/support/download/deco-e4/";break;default:a="https://www.tp-link.com/en/support/download/"}return null===e?"-":l.su.b64Decode(e)+"<a target='_blank' style='color: #4acbd6' href='"+a+"'>("+l.su.CHAR.FIRMWARE.WHATS_NEW+")</a>"}}]}}]}),this.listen({"models.firmwareTypeM.deviceType":{ev_value_change:function(e,r){var a=this.firmwareTypeObj[r];a.oversized_firmware&&"master"!==a.role&&"RE"!==this.currentMode.workMode?(t.firmwareDecoView.firmwareFile.hide(),t.firmwareDecoView.localUpgradeBtn.hide(),t.firmwareDecoView.localUpgradeGotoBtn.show()):(t.firmwareDecoView.firmwareFile.show(),t.firmwareDecoView.localUpgradeBtn.show(),t.firmwareDecoView.localUpgradeGotoBtn.hide()),this.device_ip=a.device_ip}},"stores.onlineUpgradeStore":{"ev_loaded":function(){var e=[];f.firmwareTypeObj={};for(var r=f.firmwareTypeObj,a=g.onlineUpgradeStore.getData(),i=a.length-1;0<=i;i--){var o,t,c=a[i],n=c.deviceModel,s=c.oversized_firmware,d=c.role,w=c.mac,l=c.nickName,u=c.device_ip,m=[],p="&";"disconnected"!==c.groupStatus?("master"===d&&(o=c.deviceModel),t={hw_id:c.hwId,oem_id:c.oemId,device_model:c.deviceModel,oversized_firmware:c.oversized_firmware,role:d,nickName:l,device_ip:u},s&&"master"!==d?r[n+p+w]=t:r[n]=t):g.onlineUpgradeStore.disable(c.key)}for(n in r)(m=n.split(p))[1]&&"master"!==r[n].role&&m[0]===o?delete r[n]:e.push({value:n,name:m[0]+(m[1]?"("+r[n].nickName+")":"")});g.firmwareTypeS.loadData(e)}}}),this.control({"#local-upgrade-goto-btn":{"ev_button_click":function(){window.open(location.protocol+"//"+this.device_ip+"#firmwareDeco")}},"#firmware-check-upgrades-btn":{"ev_button_click":function(){t.firmwareDecoView.checkUpgradesBtn.loading(!0),f.checkFirmware()}},"#online-upgrade-btn":{"ev_button_click":function(){f.modeFlag="online",t.firmwareDecoView.confirmUpgrade.show()}},"#manual-upgrade-file":{"ev_file_change":function(){var e=t.firmwareDecoView.firmwareFile,r=e.getFileName(),a=e.getFileSize(),i=this.checkFileName(r,"bin"),o=r.match("minimanu");""===r?e.setNormal():!0!==i?e.setError(i):0<=a&&a<1&&null===o||!f.isMobileMode&&64<a?e.setError(l.su.CHAR.ERROR["00000002"]):0<=a&&a<1||f.isMobileMode&&256<a?e.setError(l.su.CHAR.ERROR["00000002"]):e.setNormal()}},"#firmware-upgrade-msg":{"ev_msg_ok":function(){if("online"===f.modeFlag)f.startOnlineUpgrade();else if("manual"===f.modeFlag)if(f.isMobileMode){var e=a.firmwareTypeM.deviceType.getValue(),r=f.firmwareTypeObj[e];i.ajax.request({url:l.su.url("/admin/cloud?form=firmware"),data:{operation:"upload",params:{hw_id:r.hw_id,oem_id:r.oem_id,device_model:r.device_model}},timeout:3e4,success:function(e){f.startLocalUpgrade()}})}else f.startLocalUpgrade()}},"#local-upgrade-btn":{"ev_button_click":function(){f.modeFlag="manual";var e=a.firmwareTypeM.deviceType.getValue(),r=t.firmwareDecoView.firmwareFile;r.getContainer().hasClass("error")||r.isEmpty()||(null===e?a.firmwareTypeM.deviceType.setError(l.su.CHAR.VTYPETEXT.NOT_ALLOW_TO_BE_EMPTY):a.firmwareTypeM.deviceType.setNormal(),null!==e&&t.firmwareDecoView.confirmUpgrade.show())}},"#failure-retry-msg":{"ev_msg_ok":function(){f.startOnlineUpgrade()}}})}},function(n,s,a,t,d,w){var c=0;return{isMobileMode:!1,checkFirmware:function(){w.ajax.request({url:l.su.url("/admin/cloud?form=firmware_status"),data:{operation:"check"},timeout:3e4,success:function(e){var r,a,i=!1,o=e=e.fw_list;for(r=o.length-1;0<=r;r--)"disconnected"!==(a=o[r]).groupStatus&&a.need_to_upgrade&&(i=!0,t.onlineUpgradeStore.getModelByKey(a.mac).newVersion.setValue(a.new_version));s.firmwareDecoView.checkUpgradesBtn.loading(!1),i?(s.firmwareDecoView.onlineUpgradeBtn.show(),l("#check-already-update").hide(),s.firmwareDecoView.firmwareCheckCont.hide()):(s.firmwareDecoView.firmwareCheckCont.show(),l("#check-already-update").show(),s.firmwareDecoView.onlineUpgradeBtn.hide())}})},startOnlineUpgrade:function(){w.ajax.request({proxy:"firmwareDownloadProxy",success:function(){n.detectDownloadStatus()}})},detectDownloadStatus:function(){function i(){if(5===++c)return c=0,s.firmwareDecoView.progressbarWrap.hide(),s.firmwareDecoView.failRetryMsg.setContent(l.su.CHAR.ERROR["00000003"]),void s.firmwareDecoView.failRetryMsg.show();setTimeout(o,3e3)}function o(){w.ajax.request({proxy:"checkDownloadStatusProxy",success:function(e){var r=e.download_progress,a=e.status;if("fail"!==a&&"preparing"!==a){if(c=0,s.firmwareDecoView.proBar.setValue(r),100===r)return s.firmwareDecoView.proBar.setValue(100,1e3),void setTimeout(n.sendUpgradeDirective,1e3);setTimeout(o,3e3)}else i()},fail:i,error:i})}s.firmwareDecoView.proBar.reset(),s.firmwareDecoView.proBarTitle.setText(l.su.CHAR.FIRMWARE.DOWNLOADING),s.firmwareDecoView.progressbarWrap.show(),o()},sendUpgradeDirective:function(){function e(e){var r=l.su.CHAR.ERROR[e.errorCode.toString()]||l.su.CHAR.ERROR["00000004"];s.firmwareDecoView.progressbarWrap.hide(),s.firmwareDecoView.failRetryMsg.setContent(r),s.firmwareDecoView.failRetryMsg.show()}w.ajax.request({proxy:"sendUpgradeDirectiveProxy",success:function(e){var r=1e3*e.upgrade_time,a=1e3*e.reboot_time;n.animateProBar(l.su.CHAR.FIRMWARE.UPGRADING,r).then(function(){s.firmwareDecoView.progressbarWrap.hide(),d.main.startReboot(a,function(){localStorage&&localStorage.setItem("token",""),location.href="https://tplinkdeco.net"})})},fail:e,error:e})},startLocalUpgrade:function(){var e=a.firmwareTypeM.deviceType.getValue(),r=n.firmwareTypeObj[e];s.firmwareDecoView.proBar.reset(),s.firmwareDecoView.firmwareChecking.show(),s.firmwareDecoView.firmwareChecking.setText(l.su.CHAR.FIRMWARE.UPGRADING),w.ajax.upload({proxy:"uploadFirmwareProxy",fileId:"manual-upgrade-file",data:{hw_id:r.hw_id,oem_id:r.oem_id,device_model:r.device_model},timeout:72e4,success:function(e){n.sendLocalUpgradeDirective()},fail:function(){s.firmwareDecoView.firmwareChecking.hide()},error:function(){s.firmwareDecoView.firmwareChecking.hide()}})},sendLocalUpgradeDirective:function(){w.ajax.request({proxy:"sendLocalUpgradeDirectiveProxy",ajax:{timeout:5e4},success:function(e){var r=1e3*e.check_time,a=1e3*e.upgrade_time,i=n.isMobileMode?9e4:6e4,o=!0;s.firmwareDecoView.firmwareChecking.hide(),s.firmwareDecoView.progressbarWrap.show();var t=function(){o&&(s.firmwareDecoView.progressbarWrap.hide(),d.main.startReboot(i,function(){localStorage&&localStorage.setItem("token",""),location.href="https://tplinkdeco.net"}))};if(n.isMobileMode?n.animateProBar(l.su.CHAR.FIRMWARE.CHECKING,r).then(function(){return n.animateProBar(l.su.CHAR.FIRMWARE.UPGRADING,a)}).then(function(){t()}):n.animateProBar(l.su.CHAR.FIRMWARE.UPGRADING,a).then(function(){t()}),1!==e.upgrade_number||1!==e.upgrade_self_only){var c=6e4;200<e.upgrade_time&&n.isMobileMode&&(c=19e4),setTimeout(function(){w.ajax.request({proxy:"checkUpgradeStatusProxy",preventFailEvent:!0,data:{operation:"check_upgrade"},success:function(e){i=1e3*e.reboot_time},fail:function(e,r){o=!1,s.firmwareDecoView.progressbarWrap.hide(),l.su.CHAR.ERROR[r]&&d.main.showError(l.su.CHAR.ERROR[r])}})},c)}},fail:function(e,r){s.firmwareDecoView.firmwareChecking.hide(),l.su.CHAR.ERROR[r]&&d.main.showError(l.su.CHAR.ERROR[r])},error:function(){s.firmwareDecoView.firmwareChecking.hide()}})},checkFileName:function(e,r){return w.vtype.validate(e,{vtype:"string_file",extension:r})},animateProBar:function(e,r){var a=l.Deferred();return s.firmwareDecoView.proBarTitle.setText(e),s.firmwareDecoView.proBar.reset(),s.firmwareDecoView.proBar.animate({duration:r,percentageStart:0,percentageEnd:100,callback:function(){a.resolve()}}),a}}})}(jQuery);