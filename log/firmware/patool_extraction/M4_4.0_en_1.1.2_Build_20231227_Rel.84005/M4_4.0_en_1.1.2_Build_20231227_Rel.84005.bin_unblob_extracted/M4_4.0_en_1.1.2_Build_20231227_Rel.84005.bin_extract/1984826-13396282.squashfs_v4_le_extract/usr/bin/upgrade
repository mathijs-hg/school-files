#!/usr/bin/lua

local Locker = require("luci.model.locker").Locker
local sync = require "luci.model.sync"
local subprocess = require "luci.model.subprocess"
local sys = require "luci.sys"

local fw = arg[1]
assert(fw)

local fw_locker = Locker(sync.FIRMWARE_LOCK)
fw_locker:lock()

local cf_locker = Locker(sync.CONFIG_LOCK)
cf_locker:lock()

local dc_locker = Locker(sync.DEVICE_CONFIG_SAVE_LOCK)
dc_locker:lock()

subprocess.call({"nvrammanager", "-u", fw})

-- Should not reach here.
dc_locker:close()
cf_locker:close()
fw_locker:close()

local mode = require "luci.model.mode"
local upgrade_type = mode.upgrade_type_get()
if upgrade_type == "mobile_mount" then
	-- mobile_mount : use mount to store Daughter card firmwarm 
	sys.call("sync")
	sys.call("sleep 1")
	sys.call("echo 3 > /proc/sys/vm/drop_caches")
	sys.call("rm -f /tmp/firmware_upgrade_flag")
end
